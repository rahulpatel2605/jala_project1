pipeline {
    agent any
    environment {
        ACR_URL = 'jalaacr.azurecr.io' // Replace with your ACR URL
        IMAGE_NAME = "my-image" // Set your base image name
    }

    stages {
        stage('Checkout') {
            steps {
                // Checkout your source code from Git
                checkout scm
            }
        }
        stage('Build and Test') {
            steps {
                // Build and run unit tests
                sh 'chmod 755 *'
                sh './build_script.sh'
            }
        }
        stage('Build Docker Image') {
            steps {
                // Build the Docker image
                script {
                    // Generate a unique tag for your image
                    def imageTag = "${BUILD_NUMBER}"
                    
                    // Tag the Docker image
                    sh "docker build -t ${ACR_URL}/${IMAGE_NAME}:${imageTag} ."
                }
            }
        }
        stage('Push to ACR') {
            steps {
                script {
                    // Generate a unique tag for your image
                    def imageTag = "${BUILD_NUMBER}"
                    
                    // Push Docker image to Azure Container Registry
                    sh "docker push ${ACR_URL}/${IMAGE_NAME}:${imageTag}"
                }
            }
        }
        stage('Deploy to VM') {
            steps {
                // SSH into your VM and deploy the Docker container
                script {
                    def imageTag = "${BUILD_NUMBER}"
                    sh "ssh your-vm-user@your-vm-ip 'docker pull ${ACR_URL}/${IMAGE_NAME}:${imageTag}'"
                }
            }
        }
        // Add more stages for validation and email notification

        stage('Validation') {
            steps {
                // Define your validation tasks here
            }
        }

        stage('Send Email Notification') {
            steps {
                // Define your email notification here
            }
        }
    }
}
